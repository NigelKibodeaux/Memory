<html>
<head>
    <meta name="viewport" content="user-scalable=no" />
    <style>
        body {
            padding: 5px;
            margin: 0;
            font-family: sans-serif;
        }
        h1 { text-align: center }
        #container {
            margin: auto;
        }
        #intro, #instructions { margin-top: 130px; }
        .card {
            display: inline-block;
            width: 150px;
            height: 150px;
            padding: 0px;
            margin: 5px;
            background-color: gray;
            background-repeat: no-repeat;
            background-position: 150px;
        }
        /* override to put more on the page */
        .card {
            width: 120px;
            height: 120px;
            background-position: 120px;
            background-size: contain;
            border-radius: 5px;
        }
        .front, .matched {
            background-position: 0px;
            background-color: #e1e1e1;
        }
        #authorizebutton, #albums {
            margin: auto;
            font-size: 1.2em;
            text-align: center;
            display: block;
        }

    </style>
    <script>
        function shuffle(array) {
          var currentIndex = array.length
            , temporaryValue
            , randomIndex
            ;

          // While there remain elements to shuffle...
          while (0 !== currentIndex) {

            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
          }

          return array;
        }

        function hideAllUnmatched() {
            var cards = document.querySelectorAll('.front');
            for (i=0; i < cards.length; i++) {
                card = cards[i];
                card.classList.remove('front');
            }
        }

        // THE TIMER
        clearTimer = null;

        function clickHandler(event) {
            var card = false;
            if (event.srcElement.classList.contains('card'))
                card = event.srcElement;

            if (card) {
                // find other turned-over cards
                var otherCards = document.querySelectorAll('.front');

                // first card turned over
                if (otherCards.length == 0) {
                    // turn card over
                    card.classList.add('front');
                }
                // second card turned over
                else if (otherCards.length == 1 && otherCards[0] != card) {
                    var otherCard = otherCards[0];
                    var match = card.style.backgroundImage == otherCard.style.backgroundImage;

                    if (match) {
                        card.classList.remove('front')
                        card.classList.add('matched')
                        otherCard.classList.remove('front')
                        otherCard.classList.add('matched')
                    }
                    else {
                        // turn card over
                        card.classList.add('front');

                        clearTimer = setTimeout(hideAllUnmatched, 1500);
                    }
                }
                // third card clicked while 2 are shown
                // or second clicked twice
                else {
                    if (clearTimer)
                        clearTimeout(clearTimer);

                    hideAllUnmatched();
                    // turn this card over
                    card.classList.add('front');
                }
            }
        }


        function addCardsToPage(facebook_images) {
            // remove anything there now
            container.innerHTML = '';

            // highest number of ?.JPG, starting at 1.JPG
            // var HOW_MANY_IMAGES_I_HAVE = 32;
            var HOW_MANY_IMAGES_I_HAVE = facebook_images.length;
            var IMAGE_SIZE = 130;

            var paddedSize = IMAGE_SIZE + 10;

            var limit = window.innerHeight;
            var maxCols = Math.floor(window.innerWidth / paddedSize);
            var maxRows = Math.floor(window.innerHeight / paddedSize);
            var maxCards = Math.min(maxCols * maxRows, HOW_MANY_IMAGES_I_HAVE * 2);
            var maxPics = Math.floor(maxCards / 2);

            container.style.width = maxCols * paddedSize + 'px';

            var cards = [];
            for (var i=0; i<maxPics; i++) {
                cards.push(facebook_images[i]);
            }

            // make 2 of each card
            cards = cards.concat(cards);

            // shuffle
            cards = shuffle(cards);

            cards.forEach(function(o,i){
                var card = document.createElement('div');
                card.classList.add('card');
                card.style.backgroundImage = 'url(' + o.source + ')';

                container.appendChild(card);
            });

            document.body.addEventListener('click', clickHandler, false);
            document.body.addEventListener('touchstart', clickHandler, false);
        }

        function albumSelect(element) {
            var album_id = element.options[element.selectedIndex].value;
            getImages(album_id);
        }

        function getAlbums(album_list) {
            FB.api(
                '/me/albums',
                'GET',
                {},
                function(album_list) {
                    album_list.data.forEach(function(album) {
                        var option = document.createElement('option');
                        option.value = album.id;
                        option.innerText = album.name;
                        albums.appendChild(option);
                    });
                    intro.style.display = 'none';
                    albums.style.display = 'block';
                    instructions.style.display = 'block';
                }
            );
        }

        function getImages(album_id) {
            FB.api(
                '/' + album_id + '/photos',
                'GET',
                {fields:'images'},
                function(response) {
                    images = [];
                    response.data.forEach(function(x) {
                        var image = x.images.find(function(image){return image.height==130})
                        if (image) images.push(image);
                    });

                    addCardsToPage(images)
                }
            );
        }

        function authorizeWithFacebook() {
            FB.login(
                getAlbums,
                {scope: 'user_photos'}
            );
        }
    </script>
    <script src = "http://connect.facebook.net/en_US/sdk.js"></script>
</head>
<body>
    <select id="albums" onchange="albumSelect(this)" style="display:none">
        <option>Select an Album</option>
    </select>

    <div id="container">
        <div id="intro" style="display:none">
            <h1>Play memory with your very own facebook photos</h1>

            <button id="authorizebutton" onclick="authorizeWithFacebook()">
                Grant access to play
            </button>
        </div>

        <div id="instructions" style="display:none">
            <h1>&#11014; Select an album &#11014;</h1>
        </div>
    </div>

    <div
      class="fb-like"
      data-share="true"
      data-width="450"
      data-show-faces="true"
      style="position:absolute; bottom:0;">
    </div>

    <script>
        var appId = '1069602393112102'
        if (document.location.href.includes && document.location.href.includes('localhost'))
            appId = '1069605369778471'

        window.fbAsyncInit = function() {
            FB.init({
              appId      : appId,
              xfbml      : true,
              version    : 'v2.5'
            });

            FB.getLoginStatus(function(response) {
                console.log('response', response)
                if (response.status === 'connected') {
                    getAlbums();
                }
                else {
                    intro.style.display = 'block';
                }
            });
        };

        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
</body>
