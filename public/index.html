<html>
<head>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=.5" />
    <link rel="stylesheet" href="style.css">
    <script>
        // THE CARD TIMER
        var clearTimer = null;
        // THE OVERALL TIMER
        var start_time = null;
        // THE NUMBER OF CLICKS COUNTER
        var total_clicks = 0;
        // FINISHED HEADLINE
        var finished_headline = document.createElement('h1');
        finished_headline.classList.add('text');
        finished_headline.classList.add('overlay');
        finished_headline.onclick = function() {
            this.parentElement.removeChild(this);
        };


        function shuffle(array) {
          var currentIndex = array.length
            , temporaryValue
            , randomIndex
            ;

          // While there remain elements to shuffle...
          while (0 !== currentIndex) {

            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
          }

          return array;
        }

        function hideAllUnmatched() {
            var cards = document.querySelectorAll('.front');

            for (i=0; i < cards.length; i++) {
                card = cards[i];
                card.classList.remove('front');
            }
        }

        function showFinished() {
            var elapsed = Math.ceil(((new Date()) - start_time) / 100) / 10
            finished_headline.innerText = 'Done in ' + total_clicks + ' moves and ' + elapsed + ' seconds!'
            document.body.appendChild(finished_headline);
        }

        function clickHandler(event) {
            if (!start_time) start_time = new Date();
            var card = false;
            if (event.srcElement.classList.contains('card'))
                card = event.srcElement;

            if (card) {
                total_clicks++

                // find other turned-over cards
                var otherCards = document.querySelectorAll('.front');

                // first card turned over
                if (otherCards.length == 0) {
                    // turn card over
                    card.classList.add('front');
                }
                // second card turned over
                else if (otherCards.length == 1 && otherCards[0] != card) {
                    var otherCard = otherCards[0];
                    var match = card.style.backgroundImage == otherCard.style.backgroundImage;

                    if (match) {
                        card.classList.remove('front')
                        card.classList.add('matched')
                        otherCard.classList.remove('front')
                        otherCard.classList.add('matched')

                        // if this is the last one, the user has won!
                        var all_cards = document.querySelectorAll('.card').length
                        var matched_cards = document.querySelectorAll('.matched').length
                        if (all_cards === matched_cards) showFinished();
                    }
                    else {
                        // turn card over
                        card.classList.add('front');

                        clearTimer = setTimeout(hideAllUnmatched, 1500);
                    }
                }
                // third card clicked while 2 are shown
                // or second clicked twice
                else {
                    if (clearTimer)
                        clearTimeout(clearTimer);

                    hideAllUnmatched();
                    // turn this card over
                    card.classList.add('front');
                }
            }
        }


        function addCardsToPage(facebook_images) {
            // remove anything there now
            container.innerHTML = '';

            // handle albums with no images
            if (!facebook_images || !facebook_images.length) {
                container.innerHTML = "<h1>Ain't no images in this album</h1>";
                return;
            }

            // highest number of ?.JPG, starting at 1.JPG
            // var HOW_MANY_IMAGES_I_HAVE = 32;
            var HOW_MANY_IMAGES_I_HAVE = facebook_images.length;
            var IMAGE_SIZE = 130;

            var paddedSize = IMAGE_SIZE + 10;

            var limit = window.innerHeight;
            var maxCols = Math.floor(window.innerWidth / paddedSize);
            var maxRows = Math.floor(window.innerHeight / paddedSize);
            var maxCards = Math.min(maxCols * maxRows, HOW_MANY_IMAGES_I_HAVE * 2);
            var maxPics = Math.floor(maxCards / 2);

            container.style.width = maxCols * paddedSize + 'px';

            var cards = [];
            for (var i=0; i<maxPics; i++) {
                cards.push(facebook_images[i]);
            }

            // make 2 of each card
            cards = cards.concat(cards);

            // shuffle
            cards = shuffle(cards);

            cards.forEach(function(o,i){
                var card = document.createElement('div');
                card.classList.add('card');
                card.style.backgroundImage = 'url(' + o.source + ')';

                container.appendChild(card);
            });

            document.body.addEventListener('click', clickHandler, false);
            document.body.addEventListener('touchstart', clickHandler, false);

            total_clicks = 0;
        }

        function albumSelect(element) {
            var option = element.options[element.selectedIndex];
            var album_id = option.value;
            document.location = '#' + option.text;
            getImages(album_id);

            // remove finish banner
            try {
                document.body.removeChild(finished_headline)
            } catch(e) {console.log('no headline to remove')}
        }

        function getAlbums(album_list) {
            FB.api(
                '/me/albums',
                'GET',
                {},
                function(album_list) {
                    album_list.data.forEach(function(album) {
                        var option = document.createElement('option');
                        option.value = album.id;
                        option.innerText = album.name;
                        albums.appendChild(option);
                    });
                    intro.style.display = 'none';
                    albums.style.display = 'block';
                    instructions.style.display = 'block';

                    // if one is already selected in the page hash, get images for it
                    if (location.hash) {
                        var opts = Array.prototype.slice.call(albums.options);
                        opts.forEach(function(option){
                            if (location.hash.substring(1) === option.text)
                                return getImages(option.value);
                        });
                    }
                }
            );
        }

        function getImages(album_id) {
            FB.api(
                '/' + album_id + '/photos',
                'GET',
                {fields:'images'},
                function(response) {
                    images = [];
                    response.data.forEach(function(x) {
                        // we only want to 130px ones
                        var image = x.images.find(function(image){return image.height==130})
                        if (image) images.push(image);
                    });

                    addCardsToPage(images)
                }
            );
        }

        function authorizeWithFacebook() {
            FB.login(
                getAlbums,
                {scope: 'user_photos'}
            );
        }
    </script>
    <script src = "//connect.facebook.net/en_US/sdk.js"></script>
</head>
<body>
    <select id="albums" onchange="albumSelect(this)" style="display:none">
        <option>Select an Album</option>
    </select>

    <div id="container">
        <div id="intro" class="text" style="display:none">
            <h1>Play memory with your very own facebook photos</h1>

            <button id="authorizebutton" onclick="authorizeWithFacebook()">
                Let's do this thing
            </button>
        </div>

        <div id="instructions" class="text" style="display:none">
            <h1>&#11014; Select an album &#11014;</h1>
        </div>
    </div>

    <div
      class="fb-like"
      data-share="true"
      data-width="450"
      data-show-faces="true"
      style="position:absolute; bottom:0;">
    </div>

    <script>
        var appId = '1069602393112102'

        window.fbAsyncInit = function() {
            FB.init({
              appId      : appId,
              xfbml      : true,
              version    : 'v2.5'
            });

            FB.getLoginStatus(function(response) {
                console.log('response', response)
                if (response.status === 'connected') {
                    getAlbums();
                }
                else {
                    intro.style.display = 'block';
                }
            });
        };

        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

    </script>
    <script>
        /* FOR DEV */
        if (document.location.href.includes && document.location.href.includes('localhost')) {
            var images = [
                {"height":130,"source":"https://scontent.xx.fbcdn.net/v/t1.0-0/p130x130/292509_2266316294420_1811586_n.jpg?oh=1419f6ef648785ee06024451d3e8df07&oe=57F98C3D","width":162},
                {"height":130,"source":"https://scontent.xx.fbcdn.net/v/t1.0-0/p130x130/293374_2266316614428_2237586_n.jpg?oh=af940a56f4923ed005cfce107617f745&oe=57F9AB6C","width":162},
                {"height":130,"source":"https://scontent.xx.fbcdn.net/v/t1.0-0/p130x130/224484_2266316854434_2265884_n.jpg?oh=fe920e96e18b57b93f3ccec4eb18bec9&oe=580814CA","width":162},
                {"height":130,"source":"https://scontent.xx.fbcdn.net/v/t1.0-0/p130x130/185278_2266316974437_3618884_n.jpg?oh=ce9532b92b8dc811a638e7b41c8176bf&oe=57FB53AE","width":162},
                // {"height":130,"source":"https://scontent.xx.fbcdn.net/v/t1.0-0/p130x130/294354_2266317134441_6706688_n.jpg?oh=58db124f8bc584b8d011a1be376f6c40&oe=57FEEFBF","width":162},
                // {"height":130,"source":"https://scontent.xx.fbcdn.net/v/t1.0-0/p130x130/228869_2266317294445_5017070_n.jpg?oh=69c92c26963095939289fc2fb6e7ba51&oe=5802759A","width":162},
                // {"height":130,"source":"https://scontent.xx.fbcdn.net/v/t1.0-0/p130x130/316189_2293401251527_6868482_n.jpg?oh=3293050b57cbda31f43ed1c4b7922470&oe=57F54F74","width":195},
                // {"height":130,"source":"https://scontent.xx.fbcdn.net/v/t1.0-0/p130x130/308699_2293401651537_2510806_n.jpg?oh=937839bceb96712c22ec8e91bf686283&oe=580AB3A6","width":195},
            ]
            addCardsToPage(images)
        }
    </script>
</body>
